package main

import (
	"context"
	"encoding/json"
	"go-back/database"
	"go-back/services"
	"log"

	"github.com/wailsapp/wails/v2/pkg/runtime"
)

func (a *App) FrontendDispatcher(endpoint string, argJSON string) {
	//log.Printf("üõ∞ –í—ã–∑–æ–≤ FrontendDispatcher: %s, argJSON: %s", endpoint, argJSON)

	switch endpoint {
	// –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –ø–æ ID –≥—Ä—É–ø–ø—ã
	case "getSectorsByCategoryId":
		getSectorsByCategoryId(a.ctx, argJSON)

	case "sectorsToSave":
		sectorsToSave(a.ctx, argJSON)

	// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –≥—Ä—É–ø–ø –∏ –∏—Ö –∏—Ç–µ–º–æ–≤
	case "getSectors":
		getSectors(a.ctx)

	case "getSettings":
		getSettings(a.ctx)

	case "updateSettings":
		updateSettings(a, argJSON)

	case "startCollector":
		startCollector(argJSON, a)

	case "startAllCollector":
		startAllCollector(a)

	case "stopAllCollector":
		stopAllCollector(a)

	case "reconnectAllCollector":
		reconnectAllCollector(a)

	case "reconnectDonatty":
		reconnectDonatty(a)
	case "reconnectDonatepay":
		reconnectDonatepay(a)
	case "reloadRoulette":
		reloadRoulette(a)
	case "manualRouletteSpin":
		manualRouletteSpin(a)
	case "getLogs":
		getLogs(a.ctx)
	case "newStream":
		newStream(a)
	case "twitchLoginProcedure":
		twitchLoginProcedure()
	default:
		log.Printf("‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π endpoint: %s", endpoint)
	}
}

func twitchLoginProcedure() {
	services.TwitchNewToken()
}

func newStream(a *App) {
	database.LogDB.ClearDatabase()
	a.logic.ReloadRoulette()
	runtime.EventsEmit(a.ctx, "logData", map[string]any{})
}

func getLogs(ctx context.Context) {
	items, err := database.LogDB.GetLogs()
	if err != nil {
		log.Println("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤:", err)
		return
	}
	var formattedItems []map[string]interface{}
	for _, item := range items {
		formattedItems = append(formattedItems, map[string]interface{}{
			"time":  item.Time,
			"user":  item.User,
			"value": item.Item,
		})
	}
	runtime.EventsEmit(ctx, "logData", formattedItems)
}

func manualRouletteSpin(a *App) {
	a.logic.ManualRouletteSpin()
}

func reconnectDonatty(a *App) {
	a.collManager.StopCollector("Donatty")
	a.collManager.StartCollector("Donatty")
}

func reconnectDonatepay(a *App) {
	if a.collManager.IsCollectorActive("DonatePay") {
		a.collManager.StopCollector("DonatePay")
	}
	a.collManager.StartCollector("DonatePay")
}

func reloadRoulette(a *App) {
	a.logic.ReloadRoulette()
}

func getSectorsByCategoryId(ctx context.Context, data string) {
	var payload struct {
		CategoryID int `json:"category_id"`
	}
	if err := json.Unmarshal([]byte(data), &payload); err != nil {
		log.Println("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:", err)
		return
	}
	sectors, err := database.WidgetDB.GetSectorsByCategoryID(payload.CategoryID)
	if err != nil {
		log.Println("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤:", err)
		return
	}

	var formattedSectors []map[string]interface{}
	for _, sector := range sectors {
		formattedSectors = append(formattedSectors, map[string]interface{}{
			"id":     sector.ID,
			"data":   sector.Name,
			"status": nil,
		})
	}
	runtime.EventsEmit(ctx, "SectorsByCategoryIdData", formattedSectors)
}

func sectorsToSave(ctx context.Context, data string) {
	var payload struct {
		CategoryID int `json:"id"`
		Sectors    []struct {
			ID     int     `json:"id"`
			Data   string  `json:"data"`
			Status *string `json:"status"` // –º–æ–∂–µ—Ç –±—ã—Ç—å null
		} `json:"sectors"`
	}

	if err := json.Unmarshal([]byte(data), &payload); err != nil {
		log.Println("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON sectorsToSave:", err)
		return
	}
	log.Println(payload)

	for _, sector := range payload.Sectors {
		switch {
		case sector.Status == nil:
			continue

		case *sector.Status == "add":
			err := database.WidgetDB.AddSector(payload.CategoryID, sector.Data)
			if err != nil {
				log.Printf("‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: %v", err)
			}

		case *sector.Status == "edit":
			err := database.WidgetDB.UpdateSector(sector.ID, sector.Data)
			if err != nil {
				log.Printf("‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: %v", err)
			}

		case *sector.Status == "delete":
			err := database.WidgetDB.DeleteSector(sector.ID)
			if err != nil {
				log.Printf("‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: %v", err)
			}

		default:
			log.Printf("‚ö†Ô∏è –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å '%v' –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–∞ ID %d", *sector.Status, sector.ID)
		}
	}

	sectors, err := database.WidgetDB.GetSectorsByCategoryID(payload.CategoryID)
	if err != nil {
		log.Println("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤:", err)
		return
	}

	var formattedSectors []map[string]interface{}
	for _, sector := range sectors {
		formattedSectors = append(formattedSectors, map[string]interface{}{
			"id":     sector.ID,
			"data":   sector.Name,
			"status": nil,
		})
	}
	runtime.EventsEmit(ctx, "sectorsByCategoryIdData", formattedSectors)
}

func getSectors(ctx context.Context) {
	sectors, err := database.WidgetDB.GetRouletteCategorys()
	if err != nil {
		log.Println("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤:", err)
		return
	}
	result := make([]map[string]interface{}, 0)

	for _, sector := range sectors {
		sectors, err := database.WidgetDB.GetSectorsByCategoryID(sector.ID)
		if err != nil {
			log.Printf("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –¥–ª—è –≥—Ä—É–ø–ø—ã %d: %s", sector.ID, err)
			continue // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≥—Ä—É–ø–ø—É, –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫
		}

		sectorNames := make([]string, 0, len(sectors))
		for _, sector := range sectors {
			sectorNames = append(sectorNames, sector.Name)
		}

		sectorData := map[string]interface{}{
			"title":      sector.Name,
			"sectors":    sectorNames,
			"percentage": sector.Percentage,
			"color":      sector.Color,
		}
		result = append(result, sectorData)
		log.Println("‚úÖ –ì—Ä—É–ø–ø—ã:", result)
		// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Ñ—Ä–æ–Ω—Ç
		runtime.EventsEmit(ctx, "sectorsData", result)
	}
}

func getSettings(ctx context.Context) {
	settings, err := database.CredentialsDB.GetAllENVValues()
	if err != nil {
		log.Println("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:", err)
		return
	}
	result := make([]map[string]interface{}, 0)

	for _, setting := range settings {
		settingsData := map[string]interface{}{
			"name":  setting.Name,
			"value": setting.Value,
		}
		result = append(result, settingsData)
	}
	runtime.EventsEmit(ctx, "SettingsData", result)
}

func updateSettings(a *App, data string) {
	var payload struct {
		Settings []struct {
			Name  string `json:"name"`
			Value string `json:"value"`
		} `json:"settings"`
	}

	if err := json.Unmarshal([]byte(data), &payload); err != nil {
		log.Println("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON updateSettings:", err)
		return
	}
	for _, setting := range payload.Settings {
		exists, err := database.CredentialsDB.CheckENVExists(setting.Name)
		if err != nil {
			log.Printf("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ '%s': %v", setting.Name, err)
			continue
		}

		if exists {
			database.CredentialsDB.UpdateENVValue(setting.Name, setting.Value)
		} else {
			database.CredentialsDB.InsertENVValue(setting.Name, setting.Value)
		}
	}
	if a.collManager.IsActive() {
		reconnectAllCollector(a)
	}

	toastData := map[string]interface{}{
		"message": "–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã",
		"type":    "success",
	}
	runtime.EventsEmit(a.ctx, "toastExec", toastData)
}

func startCollector(data string, a *App) {
	var payload struct {
		Collector string `json:"collectorName"`
	}

	// –ø–∞—Ä—Å–∏–º JSON-—Å—Ç—Ä–æ–∫—É
	if err := json.Unmarshal([]byte(data), &payload); err != nil {
		log.Println("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON startCollector:", err)
		return
	}

	collectorName := payload.Collector
	log.Println("üîÅ –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–∞:", collectorName)

	a.collManager.StartCollector(collectorName)

}

func startAllCollector(a *App) {

	log.Println("üîÅ –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–æ–≤:")

	a.collManager.StartAllCollector()

}

func stopAllCollector(a *App) {

	log.Println("üîÅ –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–æ–≤:")

	a.collManager.StopAllCollector()

}

func reconnectAllCollector(a *App) {

	log.Println("üîÅ –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–æ–≤:")

	a.collManager.StopAllCollector()
	a.collManager.StartAllCollector()

}
